<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fweaâ€‘I Dual Remix Player</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- Wavesurfer -->
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/timeline.min.js"></script>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/volume.min.js"></script>
  <style>
    :root{--wf-h-lg:120px;--wf-h-sm:84px}
    /* mobile-friendly timeline visibility */
    .wave-timeline{display:none}
    @media(min-width:640px){.wave-timeline{display:block}}
    /* make booking buttons full-width by default */
    .neon-btn{display:block;width:100%}
    /* tighten boundary padding on mobile */
    @media(max-width:600px){
      .player-boundary{padding:1.25rem .9rem;border-radius:1.25rem}
      .playlist-section{min-width:0}
      .songbank{max-height:200px}
      .playlist-item{font-size:1rem;padding:1rem}
      .timebar{font-size:.78rem}
    }
    /* allow transport to wrap on small screens */
    #transport{flex-wrap:wrap;gap:1rem}
    /* crossfader width responsive */
    .crossfader-slider{width:min(520px,92vw)}
    /* Ensure sliders are always interactive on mobile */
    .crossfader-container,
    .crossfader-slider,
    input[type=range].volume{
      position:relative;
      z-index:50;
    }

   /* was: touch-action:none; */
.crossfader-slider{touch-action:pan-x}

    /* Extra compact mode for short landscape (e.g., iPhone 13/14) */
    @media (max-height: 500px) and (orientation: landscape){
      .player-boundary{padding:0.85rem 0.65rem;border-radius:1rem;max-width:100vw;margin:0.75rem auto}
      .playlist-row{gap:0.75rem;margin-bottom:0.6rem}
      .playlist-section{min-width:44vw;padding:0.6rem 0.55rem;border-radius:1rem}
      .playlist-title{font-size:1.05rem;margin-bottom:0.35rem}
      .playlist-item{font-size:.95rem;padding:.6rem .75rem;border-radius:.6rem}
      .songbank{max-height:28vh}
      .waveform-stack{gap:0.6rem;margin:0.5rem 0}
      .waveform-heartbeat{height:56px}
      .crossfader-container{margin:0.25rem 0}
      .crossfader-label{font-size:.95rem}
      .crossfader-slider{
        width:70vw;
        height:26px;
        border-radius:999px;
      }
      .crossfader-slider::-webkit-slider-thumb{width:24px;height:24px;margin-top:1px}
      .crossfader-slider::-moz-range-thumb{width:24px;height:24px}
      input[type=range].volume{width:150px;height:22px}
      input[type=range].volume::-webkit-slider-thumb{width:22px;height:22px}
      input[type=range].volume::-moz-range-thumb{width:22px;height:22px}
      #transport{gap:0.5rem}
      #transport svg{width:24px;height:24px}
      #transport .rounded-full{padding:0.45rem}
      .neon-btn{padding:0.85rem 0.75rem;font-size:1rem;border-radius:0.9rem}
      .timebar{font-size:.68rem;right:8px;top:4px}
    }
    @media (max-width:900px) and (orientation:portrait){
      .playlist-row{flex-direction:column}
      .waveform-heartbeat{height:var(--wf-h-sm)}
      .crossfader-slider{width:92vw}
    }
    @media (max-width:900px) and (orientation:landscape){
      /* Keep desktop feel in landscape: side-by-side lists */
      .playlist-row{flex-direction:row}
      .playlist-section{min-width:45vw}
      .songbank{max-height:42vh}
      .waveform-heartbeat{height:78px}
      .crossfader-slider{width:78vw}
    }
    /* Very small-height landscape (e.g., iPhone 13/14 landscape) */
    @media (max-height: 420px) and (orientation: landscape) {
      .player-boundary{padding:1rem .85rem;border-radius:1.25rem;max-width:100vw;margin:1rem auto}
      .playlist-row{gap:1rem;margin-bottom:1rem}
      .playlist-section{min-width:42vw;padding:0.9rem 0.75rem}
      .playlist-title{font-size:1.25rem;margin-bottom:0.5rem}
      .songbank{max-height:30vh}
      .waveform-stack{gap:0.9rem;margin:0.75rem 0}
      .waveform-heartbeat{height:66px}
      .crossfader-container{margin-top:0.4rem;margin-bottom:0.2rem}
      .crossfader-slider{width:70vw;height:28px}
      #transport{gap:0.75rem}
      #transport svg{width:28px;height:28px}
      #transport .rounded-full{padding:0.55rem}
      .master-volume-container{margin-bottom:0.6rem}
      input[type=range].volume{width:160px;height:26px}
      .timebar{font-size:.72rem;right:10px;top:6px}
    }
    @media(min-width:901px){.waveform-heartbeat{height:var(--wf-h-lg)}}
    body{background:linear-gradient(135deg,#232526 0%,#414345 100%);min-height:100vh;font-family:'Segoe UI',sans-serif;color:#fff}
    .player-boundary{background:rgba(44,44,54,.97);border-radius:2rem;box-shadow:0 8px 32px 0 rgba(31,38,135,.27);border:3px solid #00ffaa;max-width:1200px;margin:3rem auto;padding:3.5rem 2rem;position:relative}
    .playlist-row{display:flex;gap:2rem;justify-content:center;margin-bottom:2rem}
    .playlist-section{background:#2d2d35;border-radius:1.5rem;box-shadow:0 4px 24px 0 rgba(0,0,0,.18);padding:2rem 1.5rem;flex:1 1 0;min-width:320px}
    @media (orientation:landscape){
      .playlist-section{padding:1.25rem 1rem}
    }
    .songbank{max-height:260px;overflow:auto;padding-right:.25rem;scrollbar-width:thin}
    html::-webkit-scrollbar{width:8px;height:8px}
    html::-webkit-scrollbar-thumb{background:#00ffaa66;border-radius:8px}
    html::-webkit-scrollbar-track{background:#1f1f27}
    .playlist-title{font-size:1.5rem;font-weight:700;color:#00ffaa;margin-bottom:1rem;letter-spacing:1px}
    .playlist-title.remix{color:#06b6d4}
    .playlist-item{background:#23232a;border-radius:.7rem;margin-bottom:.5rem;padding:.8rem 1.2rem;font-size:1.1rem;cursor:pointer;transition:background .2s,color .2s,transform .2s}
    .playlist-item:hover,.playlist-item.active{background:linear-gradient(90deg,#00ffaa33 0%,#06b6d433 100%);color:#00ffaa;transform:scale(1.03)}
    .master-volume-container{display:flex;align-items:center;justify-content:center;margin-bottom:2rem}
    .master-volume-label{font-size:1.2rem;margin-right:1rem;color:#00ffaa;letter-spacing:1px}
    .waveform-stack{display:flex;flex-direction:column;gap:2.5rem;margin:2.5rem 0}
    .waveform-heartbeat{
      position:relative;
      width:100%;
      height:var(--wf-h-lg);
      border-radius:2rem;
      overflow:hidden; /* keep borders clipped to container */
      box-shadow:0 2px 24px 0 rgba(0,255,170,.09);
      background:transparent;
    }
    .waveform-heartbeat .heartbeat-bg{
      position:absolute;
      inset:6px;               /* insets create an even inner border */
      pointer-events:none;
      border:#00ffaa88 2px solid;
      border-radius:1.3rem;
    }
    .waveform-heartbeat:last-child .heartbeat-bg{border:#06b6d488 2px solid}
    .waveform-inner{
      position:absolute;
      inset:0;
      z-index:2; /* ensure waveform sits above decorative background */
      pointer-events:none;
    }
    /* Blend song waveform with the decorative background for a syringe-like tunnel */
    .waveform-inner canvas{
      mix-blend-mode:screen;           /* brighten where the real waveform crosses the glow */
      opacity:.95;
      filter:drop-shadow(0 0 10px rgba(0,255,170,.35));
    }
    #waveform-remix-container .waveform-inner canvas{
      filter:drop-shadow(0 0 10px rgba(6,182,212,.35));
    }
    /* Syringe rail: a faint inner gradient band the real waveform rides in */
    .syringe-rail{
      position:absolute; inset:18px 8px 18px 8px; border-radius:1.2rem; z-index:1; pointer-events:none;
      background:linear-gradient(180deg,rgba(0,0,0,.0) 0%, rgba(0,0,0,.18) 50%, rgba(0,0,0,.0) 100%),
                 linear-gradient(90deg, rgba(0,255,170,.12), rgba(255,255,255,.06) 50%, rgba(6,182,212,.12));
      box-shadow:inset 0 0 22px rgba(255,255,255,.06);
    }
    #waveform-remix-container .syringe-rail{
      background:linear-gradient(180deg,rgba(0,0,0,.0) 0%, rgba(0,0,0,.18) 50%, rgba(0,0,0,.0) 100%),
                 linear-gradient(90deg, rgba(6,182,212,.12), rgba(255,255,255,.06) 50%, rgba(0,255,170,.12));
    }
    /* Soften the decorative heartbeat SVG so it complements the real waveform */
    .waveform-heartbeat .heartbeat-bg svg{opacity:.35}
    .wave-timeline{
      position:absolute;
      left:12px;
      right:12px;
      bottom:6px;
      height:18px;
      z-index:3;
      pointer-events:none;
    }
    .timebar{
      position:absolute;
      right:16px;
      top:10px;
      z-index:4;
      font-size:.85rem;
      color:#cfe;
      text-shadow:0 0 6px rgba(0,255,170,.35);
    }
    /* Subtle inner glow for cleaner border look */
    #waveform-original-container .heartbeat-bg{box-shadow:inset 0 0 0 2px rgba(0,255,170,.28), 0 0 24px rgba(0,255,170,.08)}
    #waveform-remix-container .heartbeat-bg{box-shadow:inset 0 0 0 2px rgba(6,182,212,.28), 0 0 24px rgba(6,182,212,.08)}
    .pulse-overlay{
      position:absolute;
      left:-100%;
      top:0;
      width:8vw;
      height:100%;
      pointer-events:none;
      background:linear-gradient(90deg,transparent 0%,#00ffaa88 50%,transparent 100%);
      animation:pulse 2s linear infinite;
      opacity:.22;
      mix-blend-mode:lighten
    }
    .waveform-heartbeat:last-child .pulse-overlay{background:linear-gradient(90deg,transparent 0%,#06b6d488 50%,transparent 100%)}
    @keyframes pulse{to{left:100%}}
    .crossfader-container{display:flex;align-items:center;justify-content:center;margin-top:2rem;margin-bottom:1rem}
    .crossfader-label{font-size:1.1rem;margin:0 1rem;letter-spacing:1px;pointer-events:none;}
    .crossfader-label.original{color:#00ffaa}
    .crossfader-label.remix{color:#06b6d4}
    .crossfader-slider{
      -webkit-appearance:none; appearance:none; width:min(680px,90vw); height:36px;
      background:linear-gradient(90deg, rgba(0,255,170,.22), rgba(6,182,212,.22));
      border-radius:999px; outline:none; border:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 2px 10px rgba(0,0,0,.35), 0 6px 16px rgba(0,0,0,.25);
      touch-action:manipulation; /* allow native thumb behavior on iOS */
      -webkit-tap-highlight-color:transparent;
    }
    .crossfader-slider:focus{box-shadow:0 0 14px rgba(0,255,170,.45), 0 0 24px rgba(6,182,212,.35)}
    .crossfader-slider::-webkit-slider-runnable-track{ height:36px; border-radius:999px; background:transparent; }
    .crossfader-slider::-moz-range-track{ height:36px; border-radius:999px; background:transparent; }
    .crossfader-slider::-webkit-slider-thumb{
      -webkit-appearance:none; width:34px; height:34px; border-radius:50%; cursor:pointer;
      background: radial-gradient(circle at 30% 30%, #00ffaa, #06b6d4);
      border:1px solid rgba(255,255,255,.35);
      box-shadow:0 4px 14px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.12);
      margin-top:1px; /* center on 36px track */
    }
    .crossfader-slider::-moz-range-thumb{
      width:34px; height:34px; border:none; border-radius:50%; cursor:pointer;
      background: radial-gradient(circle at 30% 30%, #00ffaa, #06b6d4);
      box-shadow:0 4px 14px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.12);
    }
    /* Volume sliders (master & per-deck) */
    input[type=range].volume{
      -webkit-appearance:none; appearance:none; width:220px; height:30px;
      background:rgba(255,255,255,.08); border-radius:999px; border:1px solid rgba(255,255,255,.06);
      touch-action:manipulation; -webkit-tap-highlight-color:transparent;
    }
    input[type=range].volume::-webkit-slider-thumb{ -webkit-appearance:none; width:28px; height:28px; border-radius:50%; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.3); }
    input[type=range].volume::-moz-range-thumb{ width:28px; height:28px; border:none; border-radius:50%; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.3); }
    .neon-btn{box-shadow:0 0 12px 2px currentColor,0 0 32px 4px currentColor;border:2px solid currentColor;font-weight:700;transition:background .2s,color .2s,box-shadow .2s,transform .2s;background:transparent;color:inherit;text-shadow:0 0 8px currentColor}
    .neon-btn:hover{background:currentColor!important;color:#23232a!important;transform:scale(1.05);box-shadow:0 0 24px 6px currentColor,0 0 48px 12px currentColor;text-shadow:none}
    @media (max-width:900px) and (orientation:portrait){
      .playlist-row{flex-direction:column}
      .waveform-heartbeat{height:88px}
      .crossfader-slider{width:92vw}
    }
    @media (max-width:900px) and (orientation:landscape){
      .playlist-row{flex-direction:row}
      .playlist-section{min-width:45vw}
      .songbank{max-height:40vh}
      .waveform-heartbeat{height:88px}
      .crossfader-slider{width:80vw}
    }
    /* Sticky transport+crossfader on landscape mobile */
    .sticky-toolbar{position:static; z-index:60}
    @media (max-width:900px) and (orientation:landscape){
      .sticky-toolbar{
        position:sticky; top:6px; z-index:60;
        background:linear-gradient(135deg, rgba(35,37,38,.85), rgba(65,67,69,.85));
        backdrop-filter: blur(8px);
        border:1px solid rgba(255,255,255,.08);
        border-radius:18px; padding:10px 12px; margin-bottom:12px;
        box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.03);
      }
      .sticky-toolbar #transport{margin:8px 0 4px}
      .sticky-toolbar .crossfader-container{margin:6px 0 4px}
    }
  </style>
</head>
<body>
  <div class="player-boundary">
    <!-- Playlists -->
    <div class="playlist-row">
      <div class="playlist-section">
        <div class="playlist-title">Originals</div>
        <ul id="originals-list" class="songbank"></ul>
      </div>
      <div class="playlist-section">
        <div class="playlist-title remix">Remixes</div>
        <ul id="remixes-list" class="songbank"></ul>
      </div>
    </div>

    <!-- Master volume -->
    <div class="master-volume-container">
      <span class="master-volume-label">Master Volume</span>
      <input aria-label="Master Volume" type="range" id="master-volume" class="volume" min="0" max="1" step="any" value="1" />
    </div>

    <!-- Stacked waveforms -->
    <div class="waveform-stack">
      <div class="waveform-heartbeat" id="waveform-original-container">
        <div class="heartbeat-bg">
          <svg viewBox="0 0 900 120" preserveAspectRatio="none">
            <defs>
              <mask id="heartbeat-mask-original">
                <rect width="900" height="120" fill="white"/>
                <polyline points="0,60 80,60 120,100 180,20 240,100 300,60 340,60 400,80 460,40 520,100 580,60 640,60 700,80 760,40 820,100 900,60" fill="none" stroke="black" stroke-width="16" stroke-linejoin="round" stroke-linecap="round"/>
              </mask>
            </defs>
            <rect width="900" height="120" fill="#00ffaa" mask="url(#heartbeat-mask-original)" opacity="0.13"/>
          </svg>
        </div>
        <div class="syringe-rail"></div>
        <div class="pulse-overlay"></div>
        <div id="waveform-original" class="waveform-inner"></div>
        <div id="timeline-original" class="wave-timeline"></div>
        <div class="timebar"><span id="curA">0:00</span> / <span id="durA">0:00</span></div>
      </div>

      <div class="waveform-heartbeat" id="waveform-remix-container">
        <div class="heartbeat-bg">
          <svg viewBox="0 0 900 120" preserveAspectRatio="none">
            <defs>
              <mask id="heartbeat-mask-remix">
                <rect width="900" height="120" fill="white"/>
                <polyline points="0,60 60,80 120,40 180,100 240,60 300,20 360,100 420,60 480,80 540,40 600,100 660,60 720,20 780,100 840,60 900,60" fill="none" stroke="black" stroke-width="16" stroke-linejoin="round" stroke-linecap="round"/>
              </mask>
            </defs>
            <rect width="900" height="120" fill="#06b6d4" mask="url(#heartbeat-mask-remix)" opacity="0.13"/>
          </svg>
        </div>
        <div class="syringe-rail"></div>
        <div class="pulse-overlay"></div>
        <div id="waveform-remix" class="waveform-inner"></div>
        <div id="timeline-remix" class="wave-timeline"></div>
        <div class="timebar"><span id="curB">0:00</span> / <span id="durB">0:00</span></div>
      </div>
    </div>

    <!-- Sticky Transport + Crossfader (landscape mobile) -->
    <div class="sticky-toolbar">
      <!-- Transport -->
      <div id="transport" class="flex justify-center gap-6 my-8">
        <button class="flex flex-col items-center group focus:outline-none" id="play-btn">
          <div class="rounded-full bg-[#00ffaa] bg-opacity-20 p-4 mb-2 shadow-lg group-hover:bg-opacity-40 transition"><svg width="36" height="36" viewBox="0 0 36 36"><polygon points="12,8 28,18 12,28" fill="#00ffaa"/></svg></div>
          <span class="font-bold text-[#00ffaa] group-hover:underline">Play</span>
        </button>
        <button class="flex flex-col items-center group focus:outline-none" id="pause-btn">
          <div class="rounded-full bg-[#06b6d4] bg-opacity-20 p-4 mb-2 shadow-lg group-hover:bg-opacity-40 transition"><svg width="36" height="36" viewBox="0 0 36 36"><rect x="10" y="8" width="5" height="20" fill="#06b6d4"/><rect x="21" y="8" width="5" height="20" fill="#06b6d4"/></svg></div>
          <span class="font-bold text-[#06b6d4] group-hover:underline">Pause</span>
        </button>
        <button class="flex flex-col items-center group focus:outline-none" id="stop-btn">
          <div class="rounded-full bg-[#f472b6] bg-opacity-20 p-4 mb-2 shadow-lg group-hover:bg-opacity-40 transition"><svg width="36" height="36" viewBox="0 0 36 36"><rect x="10" y="10" width="16" height="16" fill="#f472b6"/></svg></div>
          <span class="font-bold text-[#f472b6] group-hover:underline">Stop</span>
        </button>
        <button class="flex flex-col items-center group focus:outline-none" id="sync-btn">
          <div class="rounded-full bg-[#a3e635] bg-opacity-20 p-4 mb-2 shadow-lg group-hover:bg-opacity-40 transition"><svg width="36" height="36" viewBox="0 0 36 36"><path d="M18 8a10 10 0 1 1-7.07 2.93" fill="none" stroke="#a3e635" stroke-width="2"/><polygon points="8,8 16,8 12,16" fill="#a3e635"/></svg></div>
          <span class="font-bold text-[#a3e635] group-hover:underline">Sync</span>
        </button>
        <button class="flex flex-col items-center group focus:outline-none" id="loop-btn" title="Loop">
          <div class="rounded-full bg-[#818cf8] bg-opacity-20 p-4 mb-2 shadow-lg group-hover:bg-opacity-40 transition"><svg width="36" height="36" viewBox="0 0 36 36"><path d="M10 18c0-4.4 3.6-8 8-8h4" fill="none" stroke="#818cf8" stroke-width="2"/><polygon points="22,6 28,10 22,14" fill="#818cf8"/><path d="M26 18c0 4.4-3.6 8-8 8h-4" fill="none" stroke="#818cf8" stroke-width="2"/><polygon points="14,30 8,26 14,22" fill="#818cf8"/></svg></div>
          <span class="font-bold text-[#818cf8] group-hover:underline">Loop</span>
        </button>
        <button class="flex flex-col items-center group focus:outline-none" id="shuffle-btn" title="Shuffle & Play">
          <div class="rounded-full bg-white bg-opacity-10 p-4 mb-2 shadow-lg group-hover:bg-opacity-30 transition">ðŸ”€</div>
          <span class="font-bold text-white group-hover:underline">Shuffle</span>
        </button>
      </div>

      <!-- Crossfader -->
      <div class="crossfader-container">
        <span class="crossfader-label original">Original</span>
        <input aria-label="Crossfader" type="range" id="crossfade" min="0" max="1" step="any" value="0.5" class="crossfader-slider" />
        <span class="crossfader-label remix">Remix</span>
      </div>
    </div>

    <!-- Booking -->
    <section class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
      <button class="neon-btn rounded-2xl px-6 py-5 text-xl text-center" style="color:#00ffaa" data-plan="standard" data-link="">Book a Remix â€” <b>$250</b> (Standard)</button>
      <button class="neon-btn rounded-2xl px-6 py-5 text-xl text-center" style="color:#06b6d4" data-plan="creator" data-link="">Creator Remix â€” <b>$500</b></button>
      <button class="neon-btn rounded-2xl px-6 py-5 text-xl text-center" style="color:#818cf8" data-plan="express" data-link="">Express Remix â€” <b>$1000</b></button>
      <button class="neon-btn rounded-2xl px-6 py-5 text-xl text-center" style="color:#fbbf24" data-plan="clean" data-link="">Clean Version Edit â€” <b>$175</b></button>
    </section>
  </div>

  <script>
    // ---- Config (EDIT THESE) ----
    const WORKER_BASE_URL = 'https://remix-exp-backend.fweago-flavaz.workers.dev';
    const PRICE_IDS = {};
    const PAYMENT_LINKS = {
      standard: 'https://buy.stripe.com/00wcN69HP9aj3A62vyfbq0a',
      creator:  'https://buy.stripe.com/aFa4gAbPXfyH9Yu6LOfbq0b',
      express:  'https://buy.stripe.com/3cI6oIg6d86f2w2b24fbq0c',
      clean:    'https://buy.stripe.com/28E3cw8DLdqz4Ea7PSfbq0d'
    };
    window.addEventListener('DOMContentLoaded', ()=>{
      const map = {standard:'standard',creator:'creator',express:'express',clean:'clean'};
      Object.entries(map).forEach(([key,plan])=>{
        const btn = document.querySelector(`[data-plan="${plan}"]`);
        if(btn && PAYMENT_LINKS[key]) btn.setAttribute('data-link', PAYMENT_LINKS[key]);
      });
      const PLAN_LABEL = {
        standard: 'Book a Remix â€” $250 (Standard)',
        creator: 'Creator Remix â€” $500',
        express: 'Express Remix â€” $1000',
        clean: 'Clean Version Edit â€” $175'
      };
      document.querySelectorAll('[data-plan]').forEach(btn=>{
        const plan = btn.getAttribute('data-plan');
        if(PLAN_LABEL[plan]) btn.setAttribute('title', PLAN_LABEL[plan]);
      });
    });

    // ---- Demo Playlists (replace with your tracks/URLs) ----
    async function loadPlaylistsFromBackend(){
      const base = WORKER_BASE_URL?.replace(/\/+$/,'');
      if(!base) return null;
      try{
        const url = `${base}/playlist?mode=auto&cb=${Date.now()}`;
        const resp = await fetch(url, {
  method: 'GET',
  headers: { 'Accept': 'application/json', 'Cache-Control': 'no-store', 'Pragma': 'no-cache' },
  cache: 'no-store',
  mode: 'cors',
  credentials: 'omit'
});
        if(!resp.ok) throw new Error(`Playlist HTTP ${resp.status}`);
        const data = await resp.json();
        if(Array.isArray(data?.pairs) && data.pairs.length){
          return data;
        }
        if(Array.isArray(data?.originals) && Array.isArray(data?.remixes)){
          return data;
        }
        throw new Error('Playlist shape not recognized');
      }catch(e){
        console.warn('Playlist fetch failed:', e);
        return null;
      }
    }

    let originals = [];
    let remixes = [];
    const DEMO_ORIGINALS = [
      {name:'Original 1',url:'https://www.kozco.com/tech/piano2-CoolEdit.mp3'},
      {name:'Original 2',url:'https://www.kozco.com/tech/organfinale.mp3'},
      {name:'Original 3',url:'https://www.kozco.com/tech/organfinale.mp3#t=10'},
      {name:'Original 4',url:'https://www.kozco.com/tech/piano2-CoolEdit.mp3#t=5'},
      {name:'Original 5',url:'https://www.kozco.com/tech/LRMonoPhase4.mp3'},
      {name:'Original 6',url:'https://www.kozco.com/tech/32.mp3'}
    ];
    const DEMO_REMIXES = [
      {name:'Remix 1',url:'https://www.kozco.com/tech/LRMonoPhase4.mp3'},
      {name:'Remix 2',url:'https://www.kozco.com/tech/32.mp3'},
      {name:'Remix 3',url:'https://www.kozco.com/tech/piano2-CoolEdit.mp3'},
      {name:'Remix 4',url:'https://www.kozco.com/tech/organfinale.mp3'},
      {name:'Remix 5',url:'https://www.kozco.com/tech/organfinale.mp3#t=20'},
      {name:'Remix 6',url:'https://www.kozco.com/tech/piano2-CoolEdit.mp3#t=15'}
    ];

    let originalWave = null, remixWave = null;
    let volA = null, volB = null; // WaveSurfer Volume plugins for each deck
    let isLooping = false;
    let masterVolume = 1;
    let currentIndex=0;

    // Render playlists
    function renderPlaylists(){
      const origUl = document.getElementById('originals-list');
      const remixUl = document.getElementById('remixes-list');
      origUl.innerHTML = ''; remixUl.innerHTML='';
      originals.forEach((t, i)=>{
        const li = document.createElement('li');
        li.className='playlist-item';
        li.textContent=t.name;
        li.setAttribute('data-index', i);
        li.tabIndex=0;
        li.onclick = ()=> selectPair(i);
        li.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'||e.key===' '||e.key==='Spacebar'){
            e.preventDefault(); selectPair(i);
          }
        });
        origUl.appendChild(li);
      });
      remixes.forEach((t, i)=>{
        const li = document.createElement('li');
        li.className='playlist-item';
        li.textContent=t.name;
        li.setAttribute('data-index', i);
        li.tabIndex=0;
        li.onclick = ()=> selectPair(i);
        li.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'||e.key===' '||e.key==='Spacebar'){
            e.preventDefault(); selectPair(i);
          }
        });
        remixUl.appendChild(li);
      });
    }

    function scrollActiveIntoView(listEl){
      const el = listEl.querySelector('.playlist-item.active');
      if(el) el.scrollIntoView({block:'nearest'});
    }

    function highlightActive(i){
      document.querySelectorAll('#originals-list .playlist-item').forEach((el, idx)=> el.classList.toggle('active', idx===i));
      document.querySelectorAll('#remixes-list .playlist-item').forEach((el, idx)=> el.classList.toggle('active', idx===i));
      scrollActiveIntoView(document.getElementById('originals-list'));
      scrollActiveIntoView(document.getElementById('remixes-list'));
    }

    // Shared AudioContext for iOS reliability
    let __sharedCtx;
    function getSharedCtx(){
      if(!__sharedCtx){
        __sharedCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(__sharedCtx.state === 'suspended') __sharedCtx.resume();
      return __sharedCtx;
    }

    function createWaveform(containerSelector, color, timelineSelector, which){
      const waveH = (window.matchMedia('(max-height: 420px) and (orientation: landscape)').matches) ? 66 : (window.matchMedia('(max-width: 600px)').matches ? 84 : 120);
      const ws = WaveSurfer.create({
        container: containerSelector,
        waveColor: 'rgba(255,255,255,0.08)',
        progressColor: color,
        height: waveH,
        barWidth: 1,
        barGap: 1,
        partialRender: true,
        normalize: true,
        responsive: true,
        cursorColor: 'rgba(255,255,255,.85)',
        backend: 'WebAudio',
        audioContext: getSharedCtx(),
      });

      // Register Volume plugin if available and remember per deck
      try {
        if (window.WaveSurfer && window.WaveSurfer.Volume) {
          const vol = ws.registerPlugin(WaveSurfer.Volume.create());
          if (which === 'A') volA = vol; else if (which === 'B') volB = vol;
        }
      } catch(_) {}

      // Attach timeline plugin if available
      try{
        if (window.WaveSurfer && window.WaveSurfer.Timeline && timelineSelector){
          ws.registerPlugin(WaveSurfer.Timeline.create({
            container: timelineSelector,
            height: 18,
            primaryColor: color,
            secondaryColor: 'rgba(255,255,255,.25)',
            style: { fontSize: '10px' }
          }));
        }
      }catch(e){ /* ignore plugin issues */ }

      ws.on('ready', ()=>{
        const c = document.querySelector(`${containerSelector} canvas`);
        if(c){ c.style.mixBlendMode='screen'; c.style.opacity='0.95'; c.style.pointerEvents = 'none'; }
      });
      return ws;
    }

    const fmtTime = (t=0)=>{
      t = Math.max(0, t|0);
      const m = (t/60)|0, s = (t%60)|0;
      return `${m}:${s.toString().padStart(2,'0')}`;
    };
    function bindTimebars(ws, curEl, durEl){
      if(!ws) return;
      ws.on('decode', dur=>{ if(durEl) durEl.textContent = fmtTime(dur); });
      ws.on('ready', ()=>{ if(durEl) durEl.textContent = fmtTime(ws.getDuration()); });
      ws.on('timeupdate', t=>{ if(curEl) curEl.textContent = fmtTime(t); });
    }

    function destroyWave(w){ if(w){ try{w.destroy()}catch(e){} } }

    function addLoop(w){ if(!w) return; w.un('finish'); w.on('finish', ()=>{ if(isLooping) w.play(0); }); }

function applyVolumes(){
  const x = Math.min(1, Math.max(0, parseFloat(document.getElementById('crossfade').value) || 0));
  const m = masterVolume;
  const angle = x * Math.PI * 0.5; // equal-power
  const vA = Math.cos(angle) * m;   // original deck
  const vB = Math.sin(angle) * m;   // remix deck

  // Prefer Volume plugin if present
  if (volA && typeof volA.setVolume === 'function') volA.setVolume(vA);
  else if (originalWave && typeof originalWave.setVolume === 'function') originalWave.setVolume(vA);
  else if (originalWave && typeof originalWave.getMediaElement === 'function' && originalWave.getMediaElement()) originalWave.getMediaElement().volume = vA;

  if (volB && typeof volB.setVolume === 'function') volB.setVolume(vB);
  else if (remixWave && typeof remixWave.setVolume === 'function') remixWave.setVolume(vB);
  else if (remixWave && typeof remixWave.getMediaElement === 'function' && remixWave.getMediaElement()) remixWave.getMediaElement().volume = vB;
}

function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const adjustWaveHeights = debounce(()=>{
  let h = 120;
  const isShortLandscape = window.matchMedia('(max-height: 420px) and (orientation: landscape)').matches;
  const isSmall = window.matchMedia('(max-width: 600px)').matches;
  if(isShortLandscape) h = 66; else if(isSmall) h = 84; else h = 120;
  try{ originalWave?.setOptions?.({height:h}); remixWave?.setOptions?.({height:h}); }catch(e){}
}, 150);
window.addEventListener('resize', adjustWaveHeights, {passive:true});
window.addEventListener('orientationchange', ()=> setTimeout(adjustWaveHeights, 150), {passive:true});
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', adjustWaveHeights, {passive:true});
}

    function syncPlay(){
      if(originalWave && remixWave && !originalWave.isPlaying()) originalWave.playPause();
      if(originalWave && remixWave && !remixWave.isPlaying()) remixWave.playPause();
    }

    // Prewarm audio for mobile Safari/Chrome: do a 1-byte ranged fetch so duration/seek is instant
    async function prewarm(url){
      if(!url) return; 
      try{ 
        await fetch(url, { method:'GET', headers:{ 'Range':'bytes=0-0' }, mode:'cors', credentials:'omit' }); 
      }catch(e){}
    }

    function selectPair(i){
      // Clamp i to valid index
      const maxIdx = Math.min(originals.length, remixes.length) - 1;
      i = Math.max(0, Math.min(i, maxIdx));
      currentIndex = i;
      // Prewarm both tracks before loading into WaveSurfer
      prewarm(originals[i]?.url || originals[0]?.url);
      prewarm(remixes[i]?.url || remixes[0]?.url);
      // Originals
      destroyWave(originalWave);
      originalWave = createWaveform('#waveform-original', '#00ffaa', '#timeline-original', 'A');
      originalWave.load(originals[i]?.url || originals[0]?.url);
      originalWave.on('ready', ()=>{ addLoop(originalWave); applyVolumes(); originalWave.play(); });
      bindTimebars(originalWave, document.getElementById('curA'), document.getElementById('durA'));
      // Remixes
      destroyWave(remixWave);
      remixWave = createWaveform('#waveform-remix', '#06b6d4', '#timeline-remix', 'B');
      remixWave.load(remixes[i]?.url || remixes[0]?.url);
      remixWave.on('ready', ()=>{ addLoop(remixWave); applyVolumes(); remixWave.play(); });
      bindTimebars(remixWave, document.getElementById('curB'), document.getElementById('durB'));
      // Sync transport
      if(originalWave && originalWave.on) originalWave.on('play', syncPlay);
      if(remixWave && remixWave.on) remixWave.on('play', syncPlay);
      highlightActive(i);
      applyVolumes();
    }

    // Transport handlers
    document.getElementById('play-btn').onclick = ()=>{ originalWave?.play(); remixWave?.play(); };
    document.getElementById('pause-btn').onclick = ()=>{ originalWave?.pause(); remixWave?.pause(); };
    document.getElementById('stop-btn').onclick = ()=>{
      originalWave?.stop(); remixWave?.stop();
      document.getElementById('curA').textContent = '0:00';
      document.getElementById('curB').textContent = '0:00';
    };
    document.getElementById('sync-btn').onclick = ()=>{
      if(originalWave && remixWave){
        const t = Math.min(originalWave.getCurrentTime(), remixWave.getCurrentTime());
        if(originalWave.getDuration()>0) originalWave.seekTo(t / originalWave.getDuration());
        if(remixWave.getDuration()>0) remixWave.seekTo(t / remixWave.getDuration());
      }
    };
    document.getElementById('loop-btn').onclick = function(){ isLooping=!isLooping; this.classList.toggle('active', isLooping); addLoop(originalWave); addLoop(remixWave); };
    document.getElementById('shuffle-btn').onclick = ()=>{ const i = Math.floor(Math.random()*Math.min(originals.length, remixes.length)); selectPair(i); };

    // Spacebar toggles Play/Pause when not typing in an input or textarea
    document.addEventListener('keydown', (e)=>{
      if(e.code === 'Space' && !e.repeat){
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if(tag !== 'input' && tag !== 'textarea'){
          e.preventDefault();
          const anyPlaying = (originalWave && originalWave.isPlaying && originalWave.isPlaying()) || (remixWave && remixWave.isPlaying && remixWave.isPlaying());
          if(anyPlaying){ originalWave?.pause(); remixWave?.pause(); }
          else { originalWave?.play(); remixWave?.play(); }
        }
      }
    });

    // ---- AudioContext unlock for mobile ----
    let __audioUnlocked=false; let __ctx;
    function unlockAudio(){
      if(__audioUnlocked) return; try{
        __ctx = __ctx || new (window.AudioContext||window.webkitAudioContext)();
        if(__ctx.state === 'suspended') { __ctx.resume(); }
        __audioUnlocked = true;
      }catch(_){/* noop */}
    }
    ['touchstart','pointerdown','mousedown','keydown'].forEach(ev=>{
      window.addEventListener(ev, unlockAudio, { once:true, passive:true });
    });

    // Volume / crossfade
// ---- Volume & Crossfader (mobile-safe, no duplicates) ----
const masterVol = document.getElementById('master-volume');
const cross     = document.getElementById('crossfade');

function applyMasterVol(v){
  masterVolume = Math.min(1, Math.max(0, parseFloat(v) || 0));
  applyVolumes();
}

function applyCross(v){
  const val = Math.min(1, Math.max(0, parseFloat(v) || 0));
  if (cross) cross.value = val;
  setCrossfade(val);
  applyVolumes();
}

// Generic range wiring that works well on iOS/Android/Desktop.
function wireRange(el, onChange){
  if(!el) return;
  const apply = () => onChange(el.value);

  // Smooth native updates
  ['input','change'].forEach(evt => el.addEventListener(evt, apply, { passive:true }));

  // Ensure the thumb has focus (iOS tracks better) and apply on grab
  ['mousedown','pointerdown','touchstart'].forEach(evt => {
    el.addEventListener(evt, () => { try{ el.focus(); }catch(_){} apply(); }, { passive:true });
  });

  // Pointer capture keeps updates flowing while dragging
  el.addEventListener('pointerdown', e => {
    try { el.setPointerCapture(e.pointerId); } catch(_) {}
  }, { passive:true });

  // While dragging, mirror value even if 'input' is throttled
  el.addEventListener('pointermove', e => {
    if ((e.buttons & 1) || e.pressure > 0) apply();
  }, { passive:true });

  // Safety: make sure we apply once more at drag end
  ['pointerup','pointercancel','touchend','mouseup'].forEach(evt => {
    window.addEventListener(evt, apply, { passive:true });
  });
}

wireRange(masterVol, applyMasterVol);
wireRange(cross,     applyCross);

// Initial
applyVolumes();

// Use native range events; keep handlers passive so scrolling is not blocked
['input','change'].forEach(evt => cross?.addEventListener(evt, e => applyCross(e.target.value), { passive: true }));
// Give the slider focus so iOS tracks the thumb properly
['touchstart','pointerdown','mousedown'].forEach(evt => cross?.addEventListener(evt, e => e.target.focus(), { passive: true }));

    function setCrossfade(v){ /* hook: if you later want visuals tied to crossfader position */ }

    // Force-open Stripe checkout outside of sandboxed iframes (Wix/embeds)
    function openCheckout(url){
      if(!url) return;
      try {
        // If we're inside an iframe, try to navigate the top window
        if (window.top && window.top !== window) {
          window.top.location.href = url;
          return;
        }
      } catch (e) {
        // Cross-origin access throws; we'll fall back to a new tab
      }
      // Fallback: open a new tab
      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if (!w) {
        // Last resort: navigate current window
        window.location.href = url;
      }
    }

    // Booking buttons â€“ Cloudflare Worker friendly, with Payment Link fallback
    async function book(plan, btn){
      const linkAttr = btn?.getAttribute('data-link')||'';
      const direct = linkAttr || PAYMENT_LINKS[plan] || '';
      if(direct){
        openCheckout(direct);
        return;
      }
      const priceId = PRICE_IDS[plan];
      const base = WORKER_BASE_URL?.replace(/\/+$/,'') || '';
      if(priceId && base){
        try{
          const resp = await fetch(`${base}/create-payment`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ type: plan, priceId })
          });
          const data = await resp.json();
          if(data?.url){
            openCheckout(data.url);
          } else {
            throw new Error(data?.error||'Unknown error');
          }
        }catch(e){
          alert('Booking failed: '+e.message);
        }
        return;
      }
      alert('Add a Stripe Payment Link (data-link or PAYMENT_LINKS) or set WORKER_BASE_URL + PRICE_IDS to enable checkout.');
    }

    document.querySelectorAll('[data-plan]').forEach(btn=> btn.addEventListener('click', ()=> book(btn.getAttribute('data-plan'), btn)));
    document.querySelectorAll('[data-plan]').forEach(btn=>{
      btn.setAttribute('role','link');
      btn.setAttribute('tabindex','0');
      btn.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar'){
          e.preventDefault();
          book(btn.getAttribute('data-plan'), btn);
        }
      });
    });

    // Init â€“ only use demo if demo=1 param is present
    (async ()=>{
      const fromBackend = await loadPlaylistsFromBackend();
      const params = new URLSearchParams(location.search);
      const useDemo = params.get('demo') === '1';
      if (!useDemo && fromBackend && Array.isArray(fromBackend.pairs) && fromBackend.pairs.length) {
        originals = fromBackend.pairs.map((p, i) => ({
          name: p.originalLabel || `Original ${String(i+1).padStart(2,'0')}`,
          url:  p.originalUrl
        }));
        remixes = fromBackend.pairs.map((p, i) => ({
          name: p.remixLabel || `Remix ${String(i+1).padStart(2,'0')}`,
          url:  p.remixUrl
        }));
      } else if (!useDemo && fromBackend && Array.isArray(fromBackend.originals) && Array.isArray(fromBackend.remixes)) {
        originals = fromBackend.originals;
        remixes   = fromBackend.remixes;
      } else {
        originals = DEMO_ORIGINALS;
        remixes   = DEMO_REMIXES;
      }
      renderPlaylists();
      if (originals.length && remixes.length) selectPair(0);
    })();
  </script>
</body>
</html>
